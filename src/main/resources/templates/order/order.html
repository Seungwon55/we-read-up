<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/css/order/order.css">
</head>
<body onload="totalProductPrice()">

<div class="container">
    <header class="top-header">
        <div class="top-inner">
            <div class="left">
                <a href="/" class="icon">&larr;</a>
            </div>
            <div class="center">
                <strong>쇼핑몰 프로젝트</strong>
            </div>
            <div class="right">
                <a class="icon">🛒</a>
                <a href="/myPage" class="icon">👤</a>
            </div>
        </div>

        <!-- ✅ 검정 탭바를 header 내부로 이동 -->
        <div class="tab-bar">
            주문/결제
        </div>
    </header>

    <section class="delivery-section">

        <div class="form-container">
            <h3 class="section-title">배송지</h3>
            <div class="form-group">
                <label for="receipt">* 받는사람</label>
                <input type="text" id="receipt" name="receipt" th:value="${orderPaymentRequest.addressDto.recipient}">
            </div>
            <div class="form-group">
                <label for="zipCode">* 주소</label>
                <div class="address-group">
                    <input type="text" id="zipCode" name="zipCode" th:value="${orderPaymentRequest.addressDto.zipCode}" placeholder="우편번호">
                </div>
            </div>
            <div class="form-group">
                <label></label>
                <input type="text" name="mainAddress" th:value="${orderPaymentRequest.addressDto.mainAddress}" placeholder="기본주소">
            </div>
            <div class="form-group">
                <label></label>
                <input type="text" name="detailAddress" th:value="${orderPaymentRequest.addressDto.detailAddress}" placeholder="나머지 주소(선택 입력 가능)">
            </div>
            <div class="form-group">
                <label for="phoneNum">* 휴대전화</label>
                <input type="tel" id="phoneNum" name="phoneNum" th:value="${orderPaymentRequest.addressDto.phoneNum}">
            </div>
            <div class="form-group">
                <select name="message">
                    <option value="">-- 메시지 선택 (선택사항) --</option>
                    <option value="배송 전에 미리 연락바랍니다.">배송 전에 미리 연락바랍니다.</option>
                    <option value="부재 시 경비실에 맡겨주세요.">부재 시 경비실에 맡겨주세요.</option>
                    <option value="부재 시 문 앞에 놓아주세요.">부재 시 문 앞에 놓아주세요.</option>
                    <option value="빠른 배송 부탁드립니다.">빠른 배송 부탁드립니다.</option>
                    <option value="택배함에 보관해 주세요.">택배함에 보관해 주세요.</option>
                </select>
            </div>
        </div>

        <div class="form-container">

            <!-- 주문 상품 영역 -->
            <h3 class="section-title">주문상품</h3>

            <div class="product-box" th:each="orderBookRequest : ${orderPaymentRequest.orderBookRequestList}">
                <img th:src="${orderBookRequest.image}" alt="상품 이미지">
                <div class="product-info">
                    <div class="product-name" th:text="${orderBookRequest.name}">샘플상품 2</div>
                    <div class="product-qty">수량: 1개</div>
                    <div id="productPrice" class="product-price" th:text="|${#numbers.formatDecimal(orderBookRequest.orderPrice, 1, 'COMMA', 0, 'POINT')}원|">10,000원</div>
                </div>
            </div>

            <!-- 배송비 -->
            <div class="shipping-fee">
                <span>배송비</span>
                <span class="price">0 원</span>
            </div>

        </div>

        <div class="form-container">

            <h3 class="section-title">할인/부가결제</h3>

            <!-- 적립금 영역 -->
            <div class="row">
                <div class="label">적립금</div>
                <input type="text" name="mileageDiscount" placeholder="0" class="point-input" id="mileageInput">
                <button type="button" class="btn-small" onclick="useFullMileage()" data-available="5000" id="useAllBtn">전액 사용</button>
            </div>

            <div class="sub-info">보유 잔액 <strong id="availableMileageText">5,000원</strong></div>

            <!-- 적용금액 -->
            <div class="total-apply">
                <span>적용금액</span>
                <span class="price discount">-0원</span>
            </div>
        </div>

        <div class="form-container">
            <div class="summary-header">
                결제정보
            </div>

            <div class="summary-item">
                <span>주문상품</span>
                <span id="totalPrice" class="totalPrice">10,000원</span>
            </div>

            <div class="summary-item">
                <span>배송비</span>
                <span class="price">+0원</span>
            </div>

            <div class="summary-item">
                <span>할인/부가결제</span>
                <span class="price discount">-0원</span>
            </div>

            <div class="final-payment">
                <span>최종 결제 금액</span>
                <span id="actualPrice" class="actualPrice">12,500원</span>
            </div>
        </div>

        <div class="form-container">
            <div class="method-header">
                <strong>결제수단</strong>
            </div>
            <p class="method-subtitle">결제수단 선택</p>

            <div class="method-option selected">
                <span>신용카드</span>
            </div>

            <div class="method-option">
                <span>위리페이</span>
            </div>
        </div>

        <div class="form-container">
            <div class="agreement-box">
                <p>구매조건 확인 및 결제진행 동의</p>
            </div>

            <div class="agreement-text">
                주문 내용을 확인하였으며 약관에 동의합니다.
            </div>

            <button class="submit-btn"><span id="paymentPrice">10,000원</span> 결제하기</button>
        </div>

    </section>
</div>





<script>
    const maxMileage = 5000; // 서버에서 동적으로 받아올 수도 있음
    const mileageInput = document.getElementById("mileageInput");
    const button = document.getElementById("useAllBtn");
    const totalPrice = document.getElementById("totalPrice");
    const actualPrice = document.getElementById("actualPrice");
    const paymentPrice = document.getElementById("paymentPrice");

    mileageInput.addEventListener("change", updateDiscountPrice);
    button.addEventListener("click", updateDiscountPrice);

    // 마일리지 입력 시 최종 결제 금액, 할인 금액 반영
    function updateDiscountPrice() {
        const value = parseInt(mileageInput.value.replace(/,/g, "")) || 0;
        const total = parseInt(totalPrice.textContent.replace(/,/g, "").replace("원", "")) || 0;

        document.querySelectorAll(".price.discount").forEach(el => {
            el.textContent = "-" + value.toLocaleString() + "원";
        });
        actualPrice.textContent = (total - value).toLocaleString() + "원";
        paymentPrice.textContent = (total - value).toLocaleString() + "원";
    }

    // 주문 총액 계산
    function totalProductPrice() {
        const productPrices = document.querySelectorAll("#productPrice");
        let total = 0;
        productPrices.forEach(p => {
            const price = parseInt(p.textContent.replace(/,/g, "")); // 콤마 제거 처리
            if (!isNaN(price)) {
                total += price;
            }
        });
        totalPrice.textContent = total.toLocaleString() + "원";
        actualPrice.textContent = total.toLocaleString() + "원";
        paymentPrice.textContent = total.toLocaleString() + "원";
    }

    // 전액 사용 버튼 클릭 시
    function useFullMileage() {
        mileageInput.value = formatNumber(maxMileage);
    }

    // 숫자 → 콤마 추가된 문자열로 포맷
    function formatNumber(num) {
        return Number(num).toLocaleString(); // 5000 → "5,000"
    }

    // 입력 시 콤마 자동 포맷 + 초과 제한
    mileageInput.addEventListener("input", function () {
        let raw = parseNumber(this.value);

        if (isNaN(raw)) {
            this.value = "";
            return;
        }

        if (raw > maxMileage) {
            raw = maxMileage;
        }

        this.value = formatNumber(raw);
    });

    // 신용카드와 위리페이 클릭 시 변경
    document.querySelectorAll(".method-option").forEach(option => {
        option.addEventListener("click", () => {
            // 모든 항목에서 .selected 제거
            document.querySelectorAll(".method-option").forEach(el => {
                el.classList.remove("selected");
            });

            // 클릭한 항목에만 .selected 추가
            option.classList.add("selected");
        });
    });
</script>

</body>
</html>