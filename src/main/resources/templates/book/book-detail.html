<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/css/fragments/header.css">
    <link rel="stylesheet" href="/css/fragments/footer.css">
    <link rel="stylesheet" href="/css/fragments/nav.css">
    <link rel="stylesheet" href="/css/book/book-detail.css">
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
    <div class="content">
        <div class="content-head">
            <div class="first-category">
                <span>홈 / 아우터</span>
            </div>

            <div class="second-category">
                <!-- 상품 이미지 -->
                <div class="product-image">
                    <img th:src="${bookDto.image}" th:alt="${bookDto.name}">
                </div>

                <!-- 상품 정보 -->
                <div class="product-info">
                    <h1 class="product-title" th:text="${bookDto.name}">캐시미어 베이직 니트</h1>
                    <!-- 지은이 (여러명가능)추가, 출판사 조인-->
                    <p>
                        <span th:each="i, stat: ${writer}" style="display:inline-block">
                            <span th:if="${stat.size != stat.count}" th:text="${i}+','"></span>
                            <span th:if="${stat.size == stat.count}" th:text="${i}+' (지은이) |'"></span>
                        </span>
                        <span th:text="${bookDto.translator}+' (역자) |'"></span>
                        <span th:text="${publisher}+' (출판) |'"></span>
                        <span th:text="${#dates.format(bookDto.releaseDate, 'yyyy-MM-dd')}"></span>
                    </p>

                    <div class="addtional-info">
                        <p><strong>정가&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong> <span th:text="${#numbers.formatInteger(bookDto.originalPrice,3,'COMMA')}+'원'"></span></p>
                        <p><strong>판매가&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>
                            <span th:text="${#numbers.formatInteger(bookDto.salePrice,3,'COMMA')}+'원'" style="font-size:23px; vertical-align: -3px;"></span>
                            <span th:text="'('+${#numbers.formatInteger(bookDto.discountPercent*100, 0)}+'%, '+${bookDto.discountPrice}+'원 할인)'"></span>
                        </p>
                        <p><strong>마일리지&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong>
                            <span th:text="${#numbers.formatInteger(#numbers.formatInteger(bookDto.originalPrice*0.05,0),3,'COMMA')}+'원(5%) + 멤버십(최대6%)'"></span>
                        </p>
                        <p><strong>배송방법&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong> 택배</p>
                        <p><strong>배송비&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong> 무료</p>
                    </div>

                    <div class="addtional-info">
                        <p class="product-detail">(최소 주문 수량 1개 이상)</p>

                        <!-- 수량 선택 -->
                        <div class="quantity-selector">
                            <button id="decrease">-</button>
                            <input type="text" id="quantity" value="1" maxlength="3" max="100">
                            <button id="increase">+</button>
                        </div>
                    </div>

                    <!-- 총 가격 -->
                    <div class="total" id="total">
                        TOTAL (Quantity)
                        <span class="total-price" id="total-price" th:text="${#numbers.formatInteger(bookDto.getSalePrice(), 3, 'COMMA')}+'원'">500,000원 (1개)</span>
                    </div>
                    <!-- 구매, 장바구니, 위시리스트 버튼 -->
                    <form class="button-group" id="btnForm">
                        <button class="buy-now">BUY IT NOW</button>
                        <button class="cart">CART</button>
                        <button class="wishlist" id="likeButton" th:style="'background-color:'+${isLikeUser == 0 ? '#fff' : 'red'}" th:text="${isLikeUser == 0 ? 'LIKE' : 'UNLIKE'}"></button>
                        <input type="hidden" id="bookId" name="bookId" th:value="${bookDto.bookId}"/>
                        <input type="hidden" id="memberId" th:value="${bookDto.bookId}"/>
                        <input type="hidden" id="isLikeUser" th:value="${isLikeUser}"/>
                    </form>
                </div>
            </div>
        </div>
        <div class="third-category">
            <div class="info-container">
                <div class="info-title">기본정보</div>
                <div class="info-details">
                    <div class="book-info">
                        <span>216쪽</span>
                        <span>145*210mm</span>
                        <span>300g</span>
                        <span>ISBN : 9788936434120</span>
                    </div>

                    <div class="category">
                        <p>
                            국내도서 > 추천도서 > <span class="highlight">올해의 책 Top 10</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="info-container">
                <div class="info-title">목차</div>
                <div class="category">
                    <p>
                        국내도서 > 추천도서 > <span class="highlight">올해의 책 Top 10</span>
                    </p>
                </div>
            </div>

            <div class="info-container">
                <div class="info-title">책소개</div>
                <div class="category">
                    <p>
                        국내도서 > 추천도서 > <span class="highlight">올해의 책 Top 10</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    $(document).ready(function () {
        let quantity = $("#quantity").val();
        let price = parseInt($("#total-price").text().replace('원','').replace(/,/g,''));

        function updateTotal(){
            let totalPrice = quantity * price;
            $('#total-price').text(totalPrice.toLocaleString()+"원");
        }

        $('#quantity').on('input', function(){
            let value = $(this).val().replace(/[^0-9]/g,'');
            $(this).val(value);

            if(value === '' || value[0] === '0'){
                value = 1;
            }

            $(this).val(value);

            quantity = parseInt(value);

            if(quantity < 1){
                quantity = 1;
                $(this).val(quantity);
                alert("1개 이상만 주문이 가능합니다.")
            }

            updateTotal();
        });

        $('#decrease').click(function(){
            if(quantity > 1){
                quantity--;
                $('#quantity').val(quantity);
                updateTotal();
            }
        });

        $('#increase').click(function(){
            if(quantity < 999){
                quantity++;
                $('#quantity').val(quantity);
                updateTotal();
            }
        });
        updateTotal();

        // 좋아요 버튼
        $('#likeButton').click(function(event) {
            event.preventDefault(); // 기본 동작 방지 (페이지 새로고침 방지)
            let bookId = $('#bookId').val();
            let currentButton = $(this); // 현재 클릭된 버튼
            let isLikeUser = parseInt($('#isLikeUser').val());
            console.log(isLikeUser);

            // 버튼 텍스트와 배경 색상을 즉시 변경
            if (isLikeUser === 0) {
                currentButton.text('UNLIKE').css('background-color', 'red');    // UNLIKE로 변경
                $('#isLikeUser').val(1);
            } else{
                currentButton.text('LIKE').css('background-color', '#fff');     // LIKE로 변경
                $('#isLikeUser').val(0);
            }

            // 서버에 bookId만 전송
            axios.post('/book/like', bookId, {
                headers: { "content-type": "application/json" }
            })
                .then(function(response) {
                    if (response.data === 'success') {
                        // 성공 시 아무런 추가 작업 필요
                    } else {
                        alert('Error: ' + response.data);
                        // 오류 발생 시 버튼을 원래 상태로 복원
                        currentButton.text('LIKE').css('background-color', '#fff');
                    }
                })
                .catch(function(error) {
                    alert('Error: ' + error);
                    // 오류 발생 시 버튼을 원래 상태로 복원
                    currentButton.text('LIKE').css('background-color', '#fff');
                });
        });

        // // 좋아요 취소 버튼
        // $('#unlike').click(function(event) {
        //     event.preventDefault(); // 기본 동작 방지 (페이지 새로고침 방지)
        //     let bookId = $('#bookId').val();
        //     let currentButton = $(this); // 현재 클릭된 버튼
        //
        //     // 버튼 텍스트와 배경 색상을 즉시 변경
        //     currentButton.text('LIKE').css('background-color', '#fff');  // LIKE로 변경
        //
        //     // 서버에 bookId만 전송
        //     axios.post('/book/like', bookId, {
        //         headers: { "content-type": "application/json" }
        //     })
        //         .then(function(response) {
        //             if (response.data === 'success') {
        //                 // 성공 시 아무런 추가 작업 필요
        //             } else {
        //                 alert('Error: ' + response.data);
        //                 // 오류 발생 시 버튼을 원래 상태로 복원
        //                 currentButton.text('UNLIKE').css('background-color', 'red');
        //             }
        //         })
        //         .catch(function(error) {
        //             alert('Error: ' + error);
        //             // 오류 발생 시 버튼을 원래 상태로 복원
        //             currentButton.text('UNLIKE').css('background-color', 'red');
        //         });
        // });


    });
</script>

</body>
</html>
